<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="sentry-trace" content="{{ trace }}"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" href="icon/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="icon/apple-touch-icon.png" />
    <link rel="apple-touch-icon" sizes="57x57" href="icon/apple-touch-icon-57x57.png" />
    <link rel="apple-touch-icon" sizes="72x72" href="icon/apple-touch-icon-72x72.png" />
    <link rel="apple-touch-icon" sizes="76x76" href="icon/apple-touch-icon-76x76.png" />
    <link rel="apple-touch-icon" sizes="114x114" href="icon/apple-touch-icon-114x114.png" />
    <link rel="apple-touch-icon" sizes="120x120" href="icon/apple-touch-icon-120x120.png" />
    <link rel="apple-touch-icon" sizes="144x144" href="icon/apple-touch-icon-144x144.png" />
    <link rel="apple-touch-icon" sizes="152x152" href="icon/apple-touch-icon-152x152.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="icon/apple-touch-icon-180x180.png" />
    <title>DU Attend v2</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css">
    <link rel="stylesheet" type="text/css"
          href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/variable/pretendardvariable.css"/>
    <script src="jquery-3.6.0.min.js"></script>
    <script src="sentry.min.js"></script>
    <style>
        body {
            font-family: Pretendard, -apple-system, BlinkMacSystemFont, system-ui, Roboto, 'Helvetica Neue', 'Segoe UI', 'Apple SD Gothic Neo', 'Noto Sans KR', 'Malgun Gothic', sans-serif;
        }

        .f18 {
            font-size: 1.6em;
        }

        .copyleft {
            margin-top: 1em;
            font-size: 0.8em;
            text-align: center;
        }

        .mt-1 {
            margin-top: 1em;
        }
    </style>
</head>
<body>

<div style="padding-left: 0.5em; padding-right: 0.5em">
    <h1 style="text-align: center;">회원정보</h1>
    <hr>

    <div class="f18" id="alert">

    </div>

    <div id="login_form" style="margin-top: 2em; margin-bottom: 2em">
        <div class="mt-1">
            <label for="username">학번(숫자 8자리)</label>
            <input type="text" id="username" disabled>
        </div>

        <div class="mt-1">
            <label for="password">암호(4~36자리)</label>
            <input type="password" id="password">
        </div>

        <div class="mt-1" id="password_new_div">
            <label for="password_new">새 암호(4~36자리)</label>
            <input type="password" id="password_new">
        </div>
    </div>

    <div>
        <ul>
            <li>학번은 변경할 수 없습니다.</li>
            <li>학번은 출석체크 URL을 생성하는 데 필요합니다.</li>
            <li>암호는 서버에 <a target="_blank"
                    href="https://ko.wikipedia.org/wiki/%EC%95%94%ED%98%B8%ED%99%94_%ED%95%B4%EC%8B%9C_%ED%95%A8%EC%88%98">단방향
                해시</a>하여 저장합니다.
            </li>
            <li>암호 변경 없이 다른 기기에서 로그아웃하려면 새 암호 칸에 기존 암호를 입력하세요.</li>
        </ul>
    </div>

    <div>
        <button id="login_btn" onclick="change_password()" style="width: 100%;">비밀번호 변경</button>
        <button id="logout_btn" onclick="logout()" style="width: 100%;">로그아웃</button>
    </div>
</div>

<div class="copyleft" style="padding-left: 0.5em; padding-right: 0.5em">
    <hr>

    <span>2021. <a href="https://works.miscthings.net">MiscThings</a></span>
</div>

<script>
    let SERVER_ADDRESS = "//attend.miscthings.net/"

    function detect_api_server() {
        return new Promise(function (resolve, reject) {
            $.ajax({
                url: "/7qy38tiejfkdnojiwgu9eyhijdfk",
                success: function (data) {
                    console.log("Hello api server!")
                    SERVER_ADDRESS = "/"
                    resolve()
                },
                error: function (xhr, status, err) {
                    resolve()
                },
                timeout: 500
            });
        })
    }


    function logout(){
        localStorage.setItem("password", "")
        window.location = "index.html"
    }


    function classroom_data(push, data) {
        let type = 0
        if (push) {
            type = 1
        }
        if (!data) {
            data = ""
        }

        return new Promise(function (resolve, reject) {
            if (localStorage.getItem("login_id") && localStorage.getItem("password")) {
                $.ajax({
                    method: "POST",
                    url: SERVER_ADDRESS + "account/action",
                    contentType: "application/json; charset=utf-8",
                    data: JSON.stringify({
                        std_id: localStorage.getItem("login_id"),
                        password: localStorage.getItem("password"),
                        type: type,
                        data: data,
                        account_register: false
                    }),
                    success: function (data) {
                        if (!data.success) {
                            window.location = "login.html"
                        }

                        $("#username").val(localStorage.getItem("login_id"))

                        if(data.new_token){
                            localStorage.setItem("password", data.new_token)
                        }

                        resolve(data.data)
                    },
                });
            } else {
                window.location = "login.html"
            }
        })
    }


    async function change_password() {
        let trylogin = $("#login_btn")
        trylogin.attr("disabled", true)

        $.ajax({
            method: "POST",
            url: SERVER_ADDRESS + "account/change_password",
            contentType: "application/json; charset=utf-8",
            data: JSON.stringify({
                std_id: $("#username").val(),
                password: $("#password").val(),
                new_password: $("#password_new").val(),
            }),
            success: function (data) {
                if (!data.success) {
                    if (data.code === "IDINVALID" || data.code === "PWINVALID" || data.code === "PWDIDNOTMATCH") {
                        alert(data.message);
                        trylogin.attr("disabled", false);
                        return;
                    }

                    if (data.code === "NOACCOUNT") {
                        window.location = "login.html"
                        trylogin.attr("disabled", false);
                        return;
                    }
                }else{
                    localStorage.setItem("login_id", $("#username").val())
                    localStorage.setItem("password", $("#password").val())

                    if(data.new_token){
                        localStorage.setItem("password", data.new_token)
                    }

                    window.location = "index.html"
                }
            }
        });
    }

    $(document).ready(async function () {
        try{
            await detect_api_server();
            await classroom_data();
        }catch (e) {

        }
    })

</script>

</body>
</html>